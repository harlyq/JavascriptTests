<!DOCTYPE html>
<html>
  <head>
    <script src="lodash.js" type="text/javascript"></script>
    <script type="text/javascript">
      (function() {
        var canvas;
        var ctx;
        var layouts = [];

        //---------------------------------
        function tween(obj, props, durationMS) {
          var starts = {};
          var ends = {};  // copy of props
          var startTime = Date.now();
          for (var p in props) {
            starts[p] = obj[p];
            ends[p] = props[p];
          }

          var tweenUpdate = function() {
            var r = (Date.now() - startTime)/durationMS;
            if (r > 1.0) {
              r = 1.0;
            }

            for (var p in starts) {
              obj[p] = easeIn(starts[p], ends[p], r);
            }

            if (r < 1.0) {
              requestAnimationFrame(tweenUpdate);
            }
          }
          requestAnimationFrame(tweenUpdate);
        }

        function assert(cond) {
          if (!cond)
            debugger;
        }

        function lerp(a, b, r) {
          return a + (b - a)*r;
        }

        function easeIn(a, b, r) {
          return a + (b - a)*r*r*r*r;
        }

        function copy(obj) {
           return JSON.parse(JSON.stringify(obj));
        }

        function isInside(obj, x, y) {
          return x > obj.x && x < obj.x + obj.width && y > obj.y && y < obj.y + obj.height;
        };

        Array.prototype.remove = function(val) {
          for (var i = this.length - 1; i >= 0; i--) {
            if (this[i] === val) {
              this.splice(i, 1);
              break;
            }
          };
        }

        //---------------------------------
        function Card(x, y, width, height) {
          this.value = Card.unique++;
          this.x = x || 0;
          this.y = y || 0;
          this.width = width || 25;
          this.height = height || 35;

          this.createImage();
        }

        Card.unique = 0;

        Card.prototype.setTopLeft = function(x, y) {
          assert(y && x);

          tween(this, {x:x, y:y}, 100);
          // this.x = x;
          // this.y = y;
        };

        Card.prototype.createImage = function() {
          // TODO use a spritesheet
          this.canvas = document.createElement("canvas");
          this.canvas.width = this.width;
          this.canvas.height = this.height;

          var ctx = this.canvas.getContext("2d");
          var offset = 8;

          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillStyle = "blue";
          ctx.strokeStyle = "white";
          ctx.lineWidth = 3;
          ctx.fillRect(0, 0, this.width, this.height);
          ctx.strokeRect(-0.5, -0.5, this.width, this.height);  // half widths for better lines
          ctx.fillStyle = "white";
          ctx.fillText(this.value.toString(), offset, offset);
          ctx.fillText(this.value.toString(), this.width - offset, this.height - offset);
        }

        Card.prototype.draw = function(ctx) {
          ctx.drawImage(this.canvas, this.x, this.y);
        };

        //---------------------------------
        function Layout(x, y, width, height) {
          this.x = x || 0;
          this.y = y || 0;
          this.width = width || 100;
          this.height = height || 100;
          this.cards = [];
          this.style = Layout.Style.Stack;
          this.interaction = Layout.Interaction.Select;
          this.selectedCards = [];
          this.selectToFront = false;
          this.selectOffset = 20;
        }

        Layout.Location = Enum("Top", "Bottom", "Random");
        Layout.Style = Enum("Stack", "Random", "Row", "Column");
        Layout.Interaction = Enum("Select", "MultiSelect", "DragDrop");
        Layout.Options = Enum("IgnoreBringToFront");

        function Enum() {
          var self = {};
          var bitFlag = 1;
          for(var i = 0; i < arguments.length; i++, bitFlag *=2) {
            self[arguments[i]] = bitFlag;
          }

          return Object.freeze(self); // return the 'self' object, instead of this function
        }

        Layout.prototype.setStyle = function(style) {
          this.style = style;
          this.layout();
        };

        Layout.prototype.addCard = function(card, loc) {
          loc = loc || Layout.Location.Top;

          switch (loc) {
            case Layout.Location.Top:
              this.cards.push(card);
              break;
            case Layout.Location.Bottom:
              this.cards.splice(0, 0, card);
              break;
            case Layout.Location.Random:
              this.cards.splice(Math.random()*this.cards.length, 0, card);
              break;
          }
        };

        Layout.prototype.removeCard = function(loc) {
          if (this.cards.length === 0)
            return null;

          loc = loc || Layout.Location.Top;

          var index = 0;
          switch (loc) {
            case Layout.Location.Top:
              index = this.cards.length - 1;
              break;
            case Layout.Location.Bottom:
              break;
            case Layout.Location.Random:
              index = Math.random()*this.cards.length;
              break;
          }
          return this.cards.splice(index, 1)[0];
        };

        Layout.prototype.layout = function() {
          var cards = this.cards;
          var numCards = cards.length;
          if (numCards <= 0)
            return;

          var cx = this.x + this.width*0.5;
          var cy = this.y + this.height*0.5;

          switch (this.style) {
            case Layout.Style.Stack:
              for (var i = numCards - 1; i >= 0; i--) {
                var card = cards[i];
                var offset = this.isSelected(card) ? this.selectOffset : 0;

                card.setTopLeft(cx - card.width*0.5 + offset, cy - card.height*0.5);
              }
              break;

            case Layout.Style.Random:
              for (var i = numCards - 1; i >= 0; i--) {
                var card = cards[i];
                var offset = this.isSelected(card) ? this.selectOffset : 0;

                card.setTopLeft(
                  this.x + offset + Math.random()*(this.width - card.width), 
                  this.y + Math.random()*(this.height - card.height));
              }
              break;

            case Layout.Style.Row:
              var cardWidth = cards[0].width;
              var delta = numCards > 1 ? ((this.width - cardWidth)*0.5)/(numCards - 1) : 0;

              for (var i = numCards - 1; i >= 0; i--) {
                var card = cards[i];
                var offset = this.isSelected(card) ? this.selectOffset : 0;

                card.setTopLeft(
                  cx + delta*(2*i - (numCards - 1)) - card.width*0.5,
                  cy - card.height*0.5 - offset);
              }
              break;

            case Layout.Style.Column:
              var cardHeight = cards[0].height;
              var delta = numCards > 1 ? ((this.height - cardHeight)*0.5)/(numCards - 1) : 0;

              for (var i = numCards - 1; i >= 0; i--) {
                var card = cards[i];
                var offset = this.isSelected(card) ? this.selectOffset : 0;

                card.setTopLeft(
                  cx - card.height*0.5 + offset,
                  cy + delta*(2*i - (numCards - 1)) - card.height*0.5);
              }
              break;
          }
        };

        Layout.prototype.draw = function(ctx) {
          ctx.fillStyle = "#a0a0ff";
          ctx.fillRect(this.x, this.y, this.width, this.height);
          ctx.fillStyle = "white";
          ctx.textAlign = "center";
          ctx.textBaseline = "middle";
          ctx.fillText("Layout", this.x + this.width*0.5, this.y + this.height*0.5);

          for (var i = 0; i < this.cards.length; i++) {
            var card = this.cards[i];
            if ( !this.selectToFront || !this.isSelected(card) ) {
              card.draw(ctx);
            }
          }

          if (this.selectToFront) {
            for (var i = 0; i < this.selectedCards.length; i++) {
              var card = this.selectedCards[i];
              card.draw(ctx);
            }
          }
        };

        Layout.prototype.shuffle = function() {
          for (var i = this.cards.length - 1; i >= 0; i--) {
            var card = this.cards[i];
            var otherIndex = ~~(Math.random()*this.cards.length);
            this.cards[i] = this.cards[otherIndex];
            this.cards[otherIndex] = card;
          }

          this.layout();
        };

        Layout.prototype.getCardFromXY = function(x, y, opts) {
          if (this.selectToFront && (!opts & Layout.Options.IgnoreBringToFront) ) {
            for (var i = this.selectedCards.length - 1; i >= 0; i--) {
              var card = this.selectedCards[i];
              if (isInside(card, x, y))
                return card;
            }
          }

          // loop backwards because last cards on top
          for (var i = this.cards.length - 1; i >= 0; i--) {
            var card = this.cards[i];
            if (isInside(card, x, y))
              return card;
          }
          return null;
        };

        Layout.prototype.setSelected = function(cards) {
          if (cards.length === 1 && cards[0] === null)
            cards = [];

          if (_.isEqual(cards, this.selectedCards))
            return; // no change

          var changedCards = _.union(cards, this.selectedCards);
          this.selectedCards = cards;
          this.layout();
        };

        Layout.prototype.addSelected = function(card) {
          assert(card);
          this.selectedCards.push(card);
          this.layout();
        };

        Layout.prototype.removeSelected = function(card) {
          assert(card);
          this.selectedCards.remove(card);
          this.layout();
        };

        Layout.prototype.isSelected = function(card) {
          return this.selectedCards.indexOf(card) !== -1;
        };

        Layout.prototype.pointerStart = function(x, y) {
          var card = this.getCardFromXY(x, y);

          switch (this.interaction) {
            case Layout.Interaction.Select:
              this.setSelected([card]);
              break;

            case Layout.Interaction.MultiSelect:
              if (card) {
                if (this.isSelected(card)) {
                  this.removeSelected(card);
                } else {
                  this.addSelected(card);
                }
              }
              break;
          }
        };

        Layout.prototype.pointerMove = function(x, y) {
          switch (this.interaction) {
            case Layout.Interaction.Select:
              var card = this.getCardFromXY(x, y, Layout.Options.IgnoreBringToFront);
              this.setSelected([card]);
              break;

            case Layout.Interaction.MultiSelect:
              break;
          }
        };

        Layout.prototype.pointerEnd = function(x, y) {
        };

        //---------------------------------
        function draw() {
          for (var i = 0; i < layouts.length; i++) {
            layouts[i].draw(ctx);
          }
        }

        function frame() {
          draw();
          requestAnimationFrame(frame);
        }

        function touchStart(e) {
          e.preventDefault();
          var x = e.touches[0].pageX - canvas.offsetLeft;
          var y = e.touches[0].pageY - canvas.offsetTop;

          for (var i = layouts.length - 1; i >= 0; i--) {
            var layout = layouts[i];
            if (isInside(layout, x, y)) {
              sourceLayout = layout;
              break;
            }
          }

          if (sourceLayout) {
            sourceLayout.pointerStart(x, y);
            document.addEventListener("touchend", touchEnd);
            document.addEventListener("touchmove", touchMove);
          }
        }

        function touchMove(e) {
          e.preventDefault();
          assert(sourceLayout);

          var x = e.touches[0].pageX - canvas.offsetLeft;
          var y = e.touches[0].pageY - canvas.offsetTop;
          sourceLayout.pointerMove(x, y);
        }

        function touchEnd(e) {
          e.preventDefault();
          if (sourceLayout) {
            document.removeEventListener("touchend", touchEnd);
            document.removeEventListener("touchmove", touchMove);
          }
        }

        var sourceLayout = null;
        function mouseDown(e) {
          e.preventDefault();
          var x = e.pageX - canvas.offsetLeft;
          var y = e.pageY - canvas.offsetTop;

          for (var i = layouts.length - 1; i >= 0; i--) {
            var layout = layouts[i];
            if (isInside(layout, x, y)) {
              sourceLayout = layout;
              break;
            }
          }

          if (sourceLayout) {
            sourceLayout.pointerStart(x, y);
            document.addEventListener("mouseup", mouseUp);
            document.addEventListener("mousemove", mouseMove);
          }
        }

        function mouseMove(e) {
          e.preventDefault();
          assert(sourceLayout);

          var x = e.pageX - canvas.offsetLeft;
          var y = e.pageY - canvas.offsetTop;
          sourceLayout.pointerMove(x, y);
        }

        function mouseUp(e) {
          e.preventDefault();
          assert(sourceLayout);

          var x = e.clientX - e.target.offsetLeft;
          var y = e.clientY - e.target.offsetTop;
          sourceLayout.pointerEnd(x, y);

          sourceLayout = null;
          document.removeEventListener("mouseup", mouseUp);
          document.removeEventListener("mousemove", mouseMove);
        }


        //---------------------------------
        window.onload = function() {
          canvas = document.getElementById("canvas");
          ctx = canvas.getContext("2d");

          canvas.addEventListener("mousedown", mouseDown);
          canvas.addEventListener("touchstart", touchStart);

          var card = new Card();
          var layout = new Layout(60, 10, 200, 200);
          layouts.push(layout);

          layout.addCard(card, Layout.Location.Random);
          assert(layout.cards.length == 1);
          var newCard = layout.removeCard(Layout.Location.Random);
          assert(layout.cards.length == 0);
          assert(card === newCard);

          layout.setStyle(Layout.Style.Row);

          for (var i = 0; i < 10; ++i) {
            var card = new Card(0, 0, 75, 105);
            layout.addCard(card);
          }

          layout.shuffle();

          requestAnimationFrame(frame);
        };
      })();
    </script>
  </head>
  <body>
    <h1>Rue Barr&#xe9;</h1>
    <h1>Rue Barr&#xe9;</h1>
    <h1>Rue Barr&#xe9;</h1>
    <h1>Rue Barr&#xe9;</h1>
    <h1>Rue Barr&#xe9;</h1>
    <h1>Rue Barr&#xe9;</h1>
    <h1>Rue Barr&#xe9;</h1>
    <h1>Rue Barr&#xe9;</h1>
    <h1>Rue Barr&#xe9;</h1>
    <h1>Rue Barr&#xe9;</h1>
    <canvas id="canvas" width="600px" height="600px"></canvas>
  </body>
</html>